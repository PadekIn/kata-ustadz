generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum MessageType {
  Promotion
  Notification
}

enum ContentType {
  Audio
  Video
  Pdf
}

enum Role {
  Admin
  User
}

enum Gender {
  Male
  Female
}

enum WatchType {
  Content
  Module
}

enum OrderStatus {
  Issued
  Unpaid
  Cancelled
  Expired
}

enum OrderType {
  Content
  Packet
}

enum CommissionStatus {
  Pending
  Paid
}

model Account {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  password      String
  role          Role      @default(User)
  otpCode       String?   @map("otp_code")
  otpExpiration DateTime? @map("otp_expiration")
  isVerified    Boolean   @default(false) @map("is_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  User         User?
  WaitingList  WaitingList?
  Notification Notification[]

  @@map("accounts")
}

model User {
  id                Int       @id @default(autoincrement())
  accountId         Int       @unique @map("account_id")
  fullname          String    @map("fullname")
  phone             String    @unique @map("phone")
  gender            Gender
  birthdate         DateTime  @map("birthdate")
  city              String
  job               String
  picture           String?
  subscriptionUntil DateTime? @map("subscription_until")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  Account          Account            @relation(fields: [accountId], references: [id], onDelete: Cascade)
  Affiliate        Affiliate?
  Content          Content[]
  Order            Order[]
  PurchasedContent PurchasedContent[]
  WatchLater       WatchLater[]
  Like             Like[]
  Comment          Comment[]
  History          History[]
  Module           Module[]
  moduleContent    moduleContent[]

  @@map("users")
}

model WaitingList {
  id        Int      @id @default(autoincrement())
  accountId Int      @map("account_id") @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  Account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("waiting_lists")
}

model Affiliate {
  id           Int    @id @default(autoincrement())
  userId       Int    @unique @map("user_id")
  referralCode String @unique @map("referral_code")
  totalEarning Float  @default(0) @map("total_earning")
  totalPayout  Float  @default(0) @map("total_payout")

  User       User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  Commission Commission[]
  Order      Order[]

  @@map("affiliates")
}

model Category {
  id        Int       @id @default(autoincrement())
  name      String
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  ContentCategory ContentCategory[]

  @@map("categories")
}

model Content {
  id         Int         @id @default(autoincrement())
  type       ContentType @default(Video)
  ustadzName String      @map("ustadz_name")
  bunnyId    String      @unique @map("bunny_id")
  url        String      @unique
  price      Int
  isActive   Boolean     @default(true) @map("is_active")
  createBy   Int         @map("create_by")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")
  deletedAt  DateTime?   @map("deleted_at")

  User User @relation(fields: [createBy], references: [id], onDelete: Cascade)

  ContentCategory  ContentCategory[]
  ModuleContent    moduleContent[]
  Comment          Comment[]
  Like             Like[]
  History          History[]
  WatchLater       WatchLater[]
  PurchasedContent PurchasedContent[]
  Order            Order[]

  @@map("contents")
}

model ContentCategory {
  contentId  Int      @map("content_id")
  categoryId Int      @map("category_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  Content  Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  Category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([contentId, categoryId])
  @@map("list_contents")
}

model Module {
  id          Int       @id @default(autoincrement())
  name        String
  image       String
  description String
  isActive    Boolean   @default(true) @map("is_active")
  createBy    Int       @map("create_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  User User @relation(fields: [createBy], references: [id], onDelete: Cascade)

  ModuleContent moduleContent[]
  WatchLater    WatchLater[]

  @@map("modules")
}

model moduleContent {
  moduleId  Int      @map("module_id")
  contentId Int      @map("content_id")
  index     Int
  createBy  Int      @map("create_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  Module  Module  @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  Content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)
  User    User    @relation(fields: [createBy], references: [id], onDelete: Cascade)

  @@id([moduleId, contentId])
  @@map("list_modules")
}

model History {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  contentId   Int       @map("content_id")
  currentTime DateTime? @map("current_time")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  User    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  Content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@map("histories")
}

model WatchLater {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("id_user")
  type      WatchType
  contentId Int?      @map("id_content")
  moduleId  Int?      @map("id_module")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  User    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Content Content? @relation(fields: [contentId], references: [id], onDelete: Cascade)
  Module  Module?  @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@map("watch_laters")
}

model Like {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  contentId Int      @map("content_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  User    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  Content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@map("likes")
}

model Comment {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  contentId Int       @map("content_id")
  text      String
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  User    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  Content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model PurchasedContent {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("id_user")
  contentId Int      @map("id_content")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  User    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  Content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@map("purchased_contents")
}

model Packet {
  id          Int       @id @default(autoincrement())
  name        String
  description String
  duration    Int
  price       Int
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  Order Order[]

  @@map("packets")
}

model Order {
  id          Int         @id @default(autoincrement())
  type        OrderType
  userId      Int         @map("user_id")
  packetId    Int?        @map("packet_id")
  contentId   Int?        @map("content_id")
  paymentId   String      @map("payment_id")
  orderStatus OrderStatus
  activeUntil DateTime?   @map("active_until")
  detailPrice Json
  affiliateId Int?        @map("affiliate_id")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  User       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  Packet     Packet?      @relation(fields: [packetId], references: [id], onDelete: Cascade)
  Content    Content?     @relation(fields: [contentId], references: [id], onDelete: Cascade)
  Affiliate  Affiliate?   @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  Commission Commission[]

  @@map("orders")
}

model Payment {
  id            Int      @id @default(autoincrement())
  method        String
  status        String
  amount        Int
  payload       Json
  transactionId String   @map("transaction_id")
  orderId       Int      @map("order_id")
  fraudStatus   String   @map("fraud_status")
  validUntil    DateTime @map("valid_until")
  date          DateTime @map("payment_date")
  token         String
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("payments")
}

model Commission {
  id          Int              @id @default(autoincrement())
  orderId     Int              @map("order_id")
  affiliateId Int              @map("affiliate_id")
  amount      Float            @default(0)
  status      CommissionStatus @default(Pending)
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  Order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  Affiliate Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@map("commissions")
}

model Notification {
  id          Int         @id @default(autoincrement())
  accountId   Int         @map("account_id")
  type        MessageType @default(Promotion)
  title       String
  description String
  createdAt   DateTime    @default(now()) @map("created_at")
  isRead      Boolean     @default(false) @map("is_read")

  Account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("notifications")
}
